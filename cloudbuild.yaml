# Google Cloud Build Configuration for BARQ Fleet Management
# Triggers: Push to main/develop branches, Pull Requests
# Deploys to: Cloud Run (staging/production)

substitutions:
  _REGION: me-central1
  _REPOSITORY: barq-fleet
  _SERVICE_BACKEND: barq-api
  _SERVICE_FRONTEND: barq-web
  _TAG: latest  # Overridden by SHORT_SHA when triggered from repo

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true
  substitution_option: 'ALLOW_LOOSE'

timeout: 3600s  # 60 minutes

steps:
  # ==============================================================================
  # STEP 1: Install Dependencies
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'install-frontend-deps'
    dir: 'frontend'
    args: ['ci']
    waitFor: ['-']

  - name: 'python:3.11-slim'
    id: 'install-backend-deps'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    waitFor: ['-']

  # ==============================================================================
  # STEP 2: Code Quality Checks
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-lint'
    dir: 'frontend'
    args: ['run', 'lint']
    waitFor: ['install-frontend-deps']

  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-type-check'
    dir: 'frontend'
    args: ['run', 'type-check']
    waitFor: ['install-frontend-deps']

  - name: 'python:3.11-slim'
    id: 'backend-lint'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install black isort flake8
        black --check app/ || echo "Black formatting issues found"
        isort --check-only app/ || echo "Import sorting issues found"
        flake8 app/ --max-line-length=100 --exclude=*/migrations/*,*/venv/* || echo "Flake8 issues found"
    waitFor: ['install-backend-deps']

  # ==============================================================================
  # STEP 3: Run Tests
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-test'
    dir: 'frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Run tests with 5-minute timeout
        timeout 300 npm run test:run || echo "Frontend tests skipped or timed out"
    env:
      - 'CI=true'
    waitFor: ['frontend-lint', 'frontend-type-check']
    # Allow to continue even if tests fail (for now)
    allowFailure: true
    timeout: 360s  # 6 minutes max

  - name: 'python:3.11-slim'
    id: 'backend-test'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install pytest pytest-cov pytest-asyncio
        pytest app/tests/ -v --cov=app --cov-report=term-missing || echo "Tests not fully implemented"
    env:
      - 'POSTGRES_SERVER=localhost'
      - 'POSTGRES_USER=postgres'
      - 'POSTGRES_PASSWORD=postgres'
      - 'POSTGRES_DB=barq_fleet_test'
      - 'SECRET_KEY=test-secret-key'
    waitFor: ['backend-lint']
    # Allow to continue even if tests fail (for now)
    allowFailure: true

  # ==============================================================================
  # STEP 4: Build Frontend
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'build-frontend'
    dir: 'frontend'
    args: ['run', 'build']
    env:
      - 'VITE_API_URL=https://${_SERVICE_BACKEND}-${_TAG}---${_REGION}.run.app/api/v1'
      - 'NODE_ENV=production'
    waitFor: ['frontend-test']

  # ==============================================================================
  # STEP 5: Build Docker Images
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '-f'
      - './backend/Dockerfile.prod'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '--build-arg'
      - 'BUILDKIT_INLINE_CACHE=1'
      - './backend'
    waitFor: ['backend-test', 'build-frontend']

  # Build frontend Docker image (nginx serving static files)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'
      - '-f'
      - './frontend/Dockerfile.prod'
      - './frontend'
    waitFor: ['build-frontend']

  # ==============================================================================
  # STEP 6: Security Scanning (optional - don't block deployment)
  # Note: Run sequentially to avoid Trivy cache lock conflicts
  # ==============================================================================
  - name: 'aquasec/trivy:latest'
    id: 'security-scan-backend'
    args:
      - 'image'
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '0'  # Don't fail build on vulnerabilities
      - '--no-progress'
      - '--timeout'
      - '5m'
      - '--cache-dir'
      - '/tmp/trivy-cache-backend'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
    waitFor: ['build-backend-image', 'build-frontend-image']
    allowFailure: true
    timeout: 360s

  - name: 'aquasec/trivy:latest'
    id: 'security-scan-frontend'
    args:
      - 'image'
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '0'
      - '--no-progress'
      - '--timeout'
      - '5m'
      - '--cache-dir'
      - '/tmp/trivy-cache-frontend'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
    waitFor: ['security-scan-backend']  # Run after backend scan to avoid cache lock
    allowFailure: true
    timeout: 360s

  # ==============================================================================
  # STEP 7: Push Docker Images
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}'
    waitFor: ['security-scan-backend']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}'
    waitFor: ['security-scan-frontend']

  # ==============================================================================
  # STEP 8: Deploy to Cloud Run (Staging)
  # Note: Removed --no-traffic flag as it's not supported when creating new services
  # Traffic management is handled via update-traffic commands in subsequent steps
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend-staging'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_BACKEND}-staging'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-env-vars'
      - 'ENVIRONMENT=staging,POSTGRES_USER=postgres,POSTGRES_DB=barq_fleet'
      - '--set-secrets'
      - 'SECRET_KEY=barq-secret-key:latest,POSTGRES_PASSWORD=barq-postgres-password:latest'
      - '--min-instances'
      - '1'
      - '--max-instances'
      - '10'
      - '--cpu'
      - '2'
      - '--memory'
      - '2Gi'
      - '--timeout'
      - '300s'
    waitFor: ['push-backend-image']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend-staging'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_FRONTEND}-staging'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '5'
      - '--cpu'
      - '1'
      - '--memory'
      - '512Mi'
    waitFor: ['push-frontend-image']

  # ==============================================================================
  # STEP 9: Smoke Tests
  # ==============================================================================
  - name: 'curlimages/curl:latest'
    id: 'smoke-test-backend'
    args:
      - '-f'
      - '--retry'
      - '5'
      - '--retry-delay'
      - '10'
      - '--retry-max-time'
      - '60'
      - 'https://${_SERVICE_BACKEND}-staging-${PROJECT_NUMBER}.${_REGION}.run.app/api/v1/health'
    waitFor: ['deploy-backend-staging']
    allowFailure: true

  - name: 'curlimages/curl:latest'
    id: 'smoke-test-frontend'
    args:
      - '-f'
      - '--retry'
      - '5'
      - '--retry-delay'
      - '10'
      - 'https://${_SERVICE_FRONTEND}-staging-${PROJECT_NUMBER}.${_REGION}.run.app/'
    waitFor: ['deploy-frontend-staging']
    allowFailure: true

  # ==============================================================================
  # STEP 10: Verify Deployment Health
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Verifying deployment health..."

        # Check backend service status
        gcloud run services describe ${_SERVICE_BACKEND}-staging \
          --region=${_REGION} \
          --format='value(status.conditions.status)' | head -1

        # Check frontend service status
        gcloud run services describe ${_SERVICE_FRONTEND}-staging \
          --region=${_REGION} \
          --format='value(status.conditions.status)' | head -1

        echo "âœ… Services deployed successfully"
    waitFor: ['smoke-test-backend', 'smoke-test-frontend']
    timeout: 120s

  # ==============================================================================
  # STEP 11: Deployment Summary
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deployment-summary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "======================================"
        echo "ðŸš€ BARQ Fleet - Deployment Summary"
        echo "======================================"
        echo ""
        # Get actual URLs from deployed services
        BACKEND_URL=$(gcloud run services describe ${_SERVICE_BACKEND}-staging --region=${_REGION} --format='value(status.url)' 2>/dev/null || echo "Not available")
        FRONTEND_URL=$(gcloud run services describe ${_SERVICE_FRONTEND}-staging --region=${_REGION} --format='value(status.url)' 2>/dev/null || echo "Not available")
        echo "Backend URL: $BACKEND_URL"
        echo "Frontend URL: $FRONTEND_URL"
        echo ""
        echo "Image Tags:"
        echo "  - Backend: ${SHORT_SHA:-${_TAG}}"
        echo "  - Frontend: ${SHORT_SHA:-${_TAG}}"
        echo ""
        echo "âœ… Deployment completed successfully!"
        echo "======================================"
    waitFor: ['verify-deployment']

# Images to be pushed to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'

# Artifacts to be stored
artifacts:
  objects:
    location: 'gs://${PROJECT_ID}_cloudbuild/builds/${BUILD_ID}'
    paths:
      - 'frontend/dist/**'
      - 'backend/coverage.xml'
