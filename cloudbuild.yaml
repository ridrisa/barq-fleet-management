# Google Cloud Build Configuration for BARQ Fleet Management
# Triggers: Push to main/develop branches, Pull Requests
# Deploys to: Cloud Run (staging/production)

substitutions:
  _REGION: us-central1
  _REPOSITORY: barq-fleet
  _SERVICE_BACKEND: barq-api
  _SERVICE_FRONTEND: barq-web
  _DATABASE_URL: ${_DATABASE_URL}  # Set in Cloud Build trigger
  _SECRET_KEY: ${_SECRET_KEY}      # Set in Secret Manager

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true
  substitution_option: 'ALLOW_LOOSE'

timeout: 3600s  # 60 minutes

steps:
  # ==============================================================================
  # STEP 1: Install Dependencies
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'install-frontend-deps'
    dir: 'frontend'
    args: ['ci']
    waitFor: ['-']

  - name: 'python:3.11-slim'
    id: 'install-backend-deps'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install --upgrade pip
        pip install -r requirements.txt -r requirements-dev.txt
    waitFor: ['-']

  # ==============================================================================
  # STEP 2: Code Quality Checks
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-lint'
    dir: 'frontend'
    args: ['run', 'lint']
    waitFor: ['install-frontend-deps']

  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-type-check'
    dir: 'frontend'
    args: ['run', 'type-check']
    waitFor: ['install-frontend-deps']

  - name: 'python:3.11-slim'
    id: 'backend-lint'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install black isort flake8
        black --check app/ || echo "Black formatting issues found"
        isort --check-only app/ || echo "Import sorting issues found"
        flake8 app/ --max-line-length=100 --exclude=*/migrations/*,*/venv/* || echo "Flake8 issues found"
    waitFor: ['install-backend-deps']

  # ==============================================================================
  # STEP 3: Run Tests
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-test'
    dir: 'frontend'
    args: ['run', 'test:run']
    env:
      - 'CI=true'
    waitFor: ['frontend-lint', 'frontend-type-check']
    # Allow to continue even if tests fail (for now)
    allowFailure: true

  - name: 'python:3.11-slim'
    id: 'backend-test'
    dir: 'backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install pytest pytest-cov pytest-asyncio
        pytest app/tests/ -v --cov=app --cov-report=term-missing || echo "Tests not fully implemented"
    env:
      - 'POSTGRES_SERVER=localhost'
      - 'POSTGRES_USER=postgres'
      - 'POSTGRES_PASSWORD=postgres'
      - 'POSTGRES_DB=barq_fleet_test'
      - 'SECRET_KEY=test-secret-key'
    waitFor: ['backend-lint']
    # Allow to continue even if tests fail (for now)
    allowFailure: true

  # ==============================================================================
  # STEP 4: Build Frontend
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'build-frontend'
    dir: 'frontend'
    args: ['run', 'build']
    env:
      - 'VITE_API_URL=https://${_SERVICE_BACKEND}-${SHORT_SHA}---${_REGION}.run.app/api/v1'
      - 'NODE_ENV=production'
    waitFor: ['frontend-test']

  # ==============================================================================
  # STEP 5: Build Docker Images
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '--build-arg'
      - 'BUILDKIT_INLINE_CACHE=1'
      - './backend'
    waitFor: ['backend-test', 'build-frontend']

  # Build frontend Docker image (nginx serving static files)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'
      - '-f'
      - './frontend/Dockerfile.prod'
      - './frontend'
    waitFor: ['build-frontend']

  # ==============================================================================
  # STEP 6: Security Scanning
  # ==============================================================================
  - name: 'aquasec/trivy:latest'
    id: 'security-scan-backend'
    args:
      - 'image'
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '0'  # Don't fail build on vulnerabilities
      - '--no-progress'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${SHORT_SHA}'
    waitFor: ['build-backend-image']

  - name: 'aquasec/trivy:latest'
    id: 'security-scan-frontend'
    args:
      - 'image'
      - '--severity'
      - 'CRITICAL,HIGH'
      - '--exit-code'
      - '0'
      - '--no-progress'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${SHORT_SHA}'
    waitFor: ['build-frontend-image']

  # ==============================================================================
  # STEP 7: Push Docker Images
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}'
    waitFor: ['security-scan-backend']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}'
    waitFor: ['security-scan-frontend']

  # ==============================================================================
  # STEP 8: Deploy to Cloud Run (Staging)
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend-staging'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_BACKEND}-staging'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${SHORT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-env-vars'
      - 'POSTGRES_SERVER=${_DATABASE_URL},SECRET_KEY=${_SECRET_KEY},ENVIRONMENT=staging'
      - '--min-instances'
      - '1'
      - '--max-instances'
      - '10'
      - '--cpu'
      - '2'
      - '--memory'
      - '2Gi'
      - '--timeout'
      - '300s'
      - '--tag'
      - '${SHORT_SHA}'
      - '--no-traffic'  # Deploy without traffic initially
    waitFor: ['push-backend-image']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend-staging'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_FRONTEND}-staging'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${SHORT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '5'
      - '--cpu'
      - '1'
      - '--memory'
      - '512Mi'
      - '--tag'
      - '${SHORT_SHA}'
      - '--no-traffic'
    waitFor: ['push-frontend-image']

  # ==============================================================================
  # STEP 9: Smoke Tests
  # ==============================================================================
  - name: 'curlimages/curl:latest'
    id: 'smoke-test-backend'
    args:
      - '-f'
      - '--retry'
      - '5'
      - '--retry-delay'
      - '10'
      - '--retry-max-time'
      - '60'
      - 'https://${_SERVICE_BACKEND}-staging-${SHORT_SHA}---${_REGION}.run.app/api/v1/health'
    waitFor: ['deploy-backend-staging']

  - name: 'curlimages/curl:latest'
    id: 'smoke-test-frontend'
    args:
      - '-f'
      - '--retry'
      - '5'
      - '--retry-delay'
      - '10'
      - 'https://${_SERVICE_FRONTEND}-staging-${SHORT_SHA}---${_REGION}.run.app/'
    waitFor: ['deploy-frontend-staging']

  # ==============================================================================
  # STEP 10: Canary Deployment (25% Traffic)
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'traffic-shift-25-backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'services'
      - 'update-traffic'
      - '${_SERVICE_BACKEND}-staging'
      - '--to-revisions'
      - '${SHORT_SHA}=25'
      - '--region'
      - '${_REGION}'
    waitFor: ['smoke-test-backend']

  # ==============================================================================
  # STEP 11: Monitor Canary (5 minutes)
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'monitor-canary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Monitoring canary deployment for 5 minutes..."
        echo "Checking for errors in Cloud Run logs..."

        # Wait 5 minutes
        sleep 300

        # Check error rate (simplified)
        ERROR_COUNT=$(gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${_SERVICE_BACKEND}-staging AND severity>=ERROR" --limit=100 --format="value(timestamp)" | wc -l)

        echo "Error count in last 5 minutes: $ERROR_COUNT"

        if [ "$ERROR_COUNT" -gt 10 ]; then
          echo "‚ùå High error rate detected! Rolling back..."
          exit 1
        fi

        echo "‚úÖ Canary looks healthy"
    waitFor: ['traffic-shift-25-backend']

  # ==============================================================================
  # STEP 12: Full Traffic Shift (100%)
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'traffic-shift-100-backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'services'
      - 'update-traffic'
      - '${_SERVICE_BACKEND}-staging'
      - '--to-latest'
      - '--region'
      - '${_REGION}'
    waitFor: ['monitor-canary']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'traffic-shift-100-frontend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'services'
      - 'update-traffic'
      - '${_SERVICE_FRONTEND}-staging'
      - '--to-latest'
      - '--region'
      - '${_REGION}'
    waitFor: ['smoke-test-frontend']

  # ==============================================================================
  # STEP 13: Deployment Summary
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deployment-summary'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "======================================"
        echo "üöÄ BARQ Fleet - Deployment Summary"
        echo "======================================"
        echo ""
        echo "Backend URL: https://${_SERVICE_BACKEND}-staging---${_REGION}.run.app"
        echo "Frontend URL: https://${_SERVICE_FRONTEND}-staging---${_REGION}.run.app"
        echo ""
        echo "Image Tags:"
        echo "  - Backend: ${SHORT_SHA}"
        echo "  - Frontend: ${SHORT_SHA}"
        echo ""
        echo "‚úÖ Deployment completed successfully!"
        echo "======================================"
    waitFor: ['traffic-shift-100-backend', 'traffic-shift-100-frontend']

# Images to be pushed to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'

# Artifacts to be stored
artifacts:
  objects:
    location: 'gs://${PROJECT_ID}_cloudbuild/builds/${BUILD_ID}'
    paths:
      - 'frontend/dist/**'
      - 'backend/coverage.xml'
