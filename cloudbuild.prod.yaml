# Google Cloud Build Configuration for BARQ Fleet Management - PRODUCTION
# OPTIMIZED for faster builds - parallel execution maximized

substitutions:
  _REGION: me-central1
  _REPOSITORY: barq-fleet
  _SERVICE_BACKEND: sync-api
  _SERVICE_FRONTEND: sync-web
  _TAG: latest
  _CLOUD_SQL_INSTANCE: barqdps:me-central1:barq-postgres-staging

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true
  substitution_option: 'ALLOW_LOOSE'

timeout: 1800s  # 30 minutes

steps:
  # ==============================================================================
  # PHASE 1: Install Dependencies (PARALLEL)
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'install-frontend-deps'
    dir: 'frontend'
    args: ['ci', '--prefer-offline', '--no-audit']
    waitFor: ['-']

  # ==============================================================================
  # PHASE 2: Lint + Type Check + Build Frontend (PARALLEL with backend)
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/npm'
    id: 'frontend-checks-and-build'
    dir: 'frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm run lint &
        npm run type-check &
        wait
        npm run build
    env:
      - 'VITE_API_URL=https://${_SERVICE_BACKEND}-${PROJECT_NUMBER}.${_REGION}.run.app/api/v1'
      - 'NODE_ENV=production'
    waitFor: ['install-frontend-deps']

  # ==============================================================================
  # PHASE 2: Build Docker Images (PARALLEL - start early)
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '-f'
      - './backend/Dockerfile.prod'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
      - '--build-arg'
      - 'BUILDKIT_INLINE_CACHE=1'
      - './backend'
    waitFor: ['-']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'
      - '-f'
      - './frontend/Dockerfile.prod'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'
      - '--build-arg'
      - 'BUILDKIT_INLINE_CACHE=1'
      - './frontend'
    waitFor: ['frontend-checks-and-build']

  # ==============================================================================
  # PHASE 3: Push Images (PARALLEL - as soon as each image is ready)
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-image'
    args: ['push', '--all-tags', '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}']
    waitFor: ['build-backend-image']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-image'
    args: ['push', '--all-tags', '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}']
    waitFor: ['build-frontend-image']

  # ==============================================================================
  # PHASE 4: Deploy PRODUCTION (with Cloud SQL connection)
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend-prod'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_BACKEND}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--add-cloudsql-instances'
      - '${_CLOUD_SQL_INSTANCE}'
      - '--set-env-vars'
      - 'ENVIRONMENT=production,POSTGRES_USER=postgres,POSTGRES_DB=barq_fleet,POSTGRES_SERVER=/cloudsql/${_CLOUD_SQL_INSTANCE},UPSTASH_REDIS_REST_URL=https://fine-lobster-35915.upstash.io,GOOGLE_CLIENT_ID=869422381378-9sonvj1dnjoh465826dcjrn4jo9r0hon.apps.googleusercontent.com'
      - '--set-secrets'
      - 'SECRET_KEY=barq-secret-key:latest,POSTGRES_PASSWORD=barq-postgres-password:latest,UPSTASH_REDIS_REST_TOKEN=upstash-redis-token:latest'
      - '--min-instances'
      - '1'
      - '--max-instances'
      - '50'
      - '--cpu'
      - '2'
      - '--memory'
      - '2Gi'
      - '--timeout'
      - '300s'
      - '--concurrency'
      - '100'
    waitFor: ['push-backend-image']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend-prod'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_FRONTEND}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '1'
      - '--max-instances'
      - '20'
      - '--cpu'
      - '1'
      - '--memory'
      - '512Mi'
    waitFor: ['push-frontend-image']

  # ==============================================================================
  # PHASE 5: Verification (smoke tests)
  # ==============================================================================
  - name: 'curlimages/curl:latest'
    id: 'smoke-test'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Waiting for services to be ready..."
        sleep 15
        curl -sf --retry 5 --retry-delay 5 "https://${_SERVICE_BACKEND}-${PROJECT_NUMBER}.${_REGION}.run.app/health" && echo "Backend OK" || echo "Backend check failed"
        curl -sf --retry 5 --retry-delay 5 "https://${_SERVICE_FRONTEND}-${PROJECT_NUMBER}.${_REGION}.run.app/" && echo "Frontend OK" || echo "Frontend check failed"
        echo "Production deployment complete!"
    waitFor: ['deploy-backend-prod', 'deploy-frontend-prod']
    allowFailure: true

# Images to be pushed to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:${_TAG}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_BACKEND}:latest'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:${_TAG}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_FRONTEND}:latest'
